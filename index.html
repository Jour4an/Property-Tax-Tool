<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Balance Your City</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
  /* --- BASE STYLING --- */
  body { 
    font-family: 'Montserrat', sans-serif; 
    background: #f0f0f0; 
    margin: 0; 
    padding: 0; 
    color: #333; 
  }
  .section { 
    background: #fff; 
    border-radius: 15px; 
    padding: 30px; 
    margin: 20px auto; 
    max-width: 900px; 
    /* INCREASED SPACE: Ensures the floating bar clears content at the bottom */
    padding-bottom: 180px; 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
  }
  h1 { 
    color: #1a73e8; 
    font-size: 2.2em; 
    font-weight: 900; 
    text-align: center; 
    margin-bottom: 25px; 
  }
  h3 {
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
      margin-top: 30px; 
      font-weight: 700; 
  }
  .intro-text { 
    font-size: 1em; 
    color: #555; 
    margin-bottom: 20px; 
  }
  
  /* --- DISCLAIMER STYLE --- */
  .disclaimer {
      padding: 15px 20px;
      margin-bottom: 25px;
      border: 1px solid #c3daff;
      border-radius: 8px;
      background-color: #f0f5ff; 
      font-size: 0.9em;
      color: #1565c0; 
  }
  .disclaimer strong {
      color: #0d47a1; 
  }

  /* --- Progress Bar --- */
  .progress-bar { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 25px; 
    background: #e0e0e0; 
    padding: 5px;
    border-radius: 10px; 
  }
  .year { 
    flex: 1; 
    text-align: center; 
    padding: 10px 5px; 
    border-radius: 8px; 
    background: #ccc; 
    margin: 0 2px; 
    font-weight: 700; 
    color: #666; 
    transition: all 0.3s ease;
  }
  .year.active { 
    background: #1a73e8; 
    color: #fff; 
  }
  .year.completed {
    background: #4CAF50; 
    color: #fff;
  }

  /* --- Sliders/Cards --- */
  .slider-card { 
    display: flex; 
    align-items: center; /* Vertically center all items in the row */
    margin-bottom: 20px; 
    padding: 20px; 
    border-radius: 10px; 
    background: #f9f9f9; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
  }
  
  /* Canvas positioning */
  .slider-card canvas {
      /* Consistent spacing for both department and tax canvases */
      margin-right: 20px; 
      flex-shrink: 0;
  }
  
  .slider-card .slider-content {
    /* Ensure department sliders take full width */
    width: 100%;
    flex-grow: 1; 
  }

  /* TAX ADJUSTER CONTAINER - NEW FLEX ROW */
  #taxAdjusterContainer { 
      display: flex;
      align-items: center; /* Vertically center all items in the row */
      gap: 15px;
      margin-top: 5px;
  }
  #taxAdjusterContainer input[type="range"] {
      flex-grow: 1;
      margin-bottom: 0;
  }
  
  #cumulativeTaxDisplay {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
  }
  .tax-label {
      font-size: 0.8em;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      text-align: center;
  }
  
  /* Input Range Styling */
  input[type="range"] { 
    width: 100%; 
    height: 8px; 
    -webkit-appearance: none; 
    background: #ddd; 
    border-radius: 5px; 
    outline: none; 
    margin-top: 5px;
    transition: opacity 0.3s ease;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    background: #1a73e8; 
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }
  
  /* Tax Breakdown Styling */
  .tax-breakdown div {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px dashed #eee;
      font-size: 0.9em;
  }
  .tax-breakdown div strong {
      color: #333;
  }
  .tax-breakdown .total {
      border-top: 2px solid #ddd;
      border-bottom: none;
      font-size: 1.1em;
      font-weight: 700;
      padding-top: 10px;
      color: #1a73e8;
  }


  /* --- Project Buttons --- */
  #projectButtons > .projects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; 
      margin-top: 10px;
  }
  
  /* BASE PROJECT BUTTON (Additional Projects) */
  .project-btn { 
      background: linear-gradient(to bottom, #4CAF50, #2E8B57); 
      border: 1px solid #2E8B57; 
      color: white; 
      padding: 15px; 
      border-radius: 12px;
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.2s ease;
      height: 100%;
      box-shadow: 0 4px 0 0 #1B5E20; 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center; /* Ensure internal text is centered */
  }
  
  /* CRITICAL (REQUIRED) PROJECT BUTTON STYLE */
  .project-btn.required {
      background: linear-gradient(to bottom, #FF5733, #C70039); 
      border: 3px solid #C70039; 
      font-weight: 700;
      color: white; 
      box-shadow: 0 4px 0 0 #B71C1C; 
  }
  
  /* === CRITICAL PROJECT STYLING: Dollar amount white === */
  .project-btn.required .project-cost {
      color: white; 
  }
  
  /* HOVER EFFECT */
  .project-btn:hover:not(:disabled) { 
      box-shadow: 0 2px 0 0 #9E9E9E; 
      transform: translateY(2px); 
  }
  
  /* SELECTED STATE - Darker background with Gold Outline */
  .project-btn.selected { 
      background: #212121 !important; 
      color: white; 
      border: 3px solid #FFD700; 
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.7); 
      transform: translateY(0);
  }
  /* Selected Critical buttons (Required) */
  .project-btn.required.selected {
      background: #212121 !important; 
      border: 3px solid #FFD700; 
      color: white;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.9);
  }
  
  /* Disabled/Completed Style */
  .project-btn.completed {
    background: #f1f1f1;
    color: #777;
    border-color: #ddd;
    box-shadow: 0 0 0 0 #999;
    cursor: default;
    opacity: 0.8;
  }
  
  .project-title {
      font-weight: 900; 
      font-size: 1.1em;
      margin-bottom: 5px;
      text-align: center;
      color: white; 
  }
  
  .project-btn.selected .project-cost {
      color: #FFD700; 
  }
  
  .project-btn.required.selected .project-cost {
      color: white; /* Keep white for required even when selected */
  }
  
  /* Highlight critical text */
  .required-text {
      font-weight: 900; 
      color: white; 
      font-size: 0.8em;
      margin-top: 5px;
      text-align: center;
      border-top: 1px dashed #ccc;
      padding-top: 5px;
      width: 100%; 
  }
  
  /* === CRITICAL DEADLINE TEXT COLOR: Yellow highlight === */
  .project-btn.required .required-text, 
  .project-btn.required.selected .required-text {
      color: #fcd34d !important; /* Yellow for visibility */
      border-top-color: white !important; 
  }
  
  .project-btn.selected .required-text {
      border-top-color: #FFD700;
  }
  
  /* --- Floating Controls (Fixed position and flex layout) --- */
  .floating-controls {
    position: fixed; 
    bottom: 0; 
    left: 0; 
    width: 100%;
    background: #333; 
    box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
    z-index: 100;
    
    display: flex; 
    flex-direction: column; 
    /* FIX: Made floater smaller by reducing vertical padding */
    padding: 15px 20px 0; 
    box-sizing: border-box;
  }

  /* --- Wrapper for the main row of buttons/status --- */
  .floating-action-row {
      display: flex;
      flex-wrap: nowrap; 
      justify-content: flex-start;
      align-items: center;
      gap: 15px;
      padding-bottom: 10px; 
      overflow-x: auto; 
  }

  /* 1. Status Display */
  #statusDisplay {
    color: white; 
    font-size: 1.1em; 
    font-weight: 700; 
    padding: 8px 15px; 
    border-radius: 5px;
    flex-shrink: 0; 
    min-width: 150px; 
    /* ADDED: Ensure balance text is centered */
    text-align: center; 
  }
  #statusDisplay.shortfall { background: #C70039; }
  #statusDisplay.surplus { background: #4CAF50; }
  #statusDisplay.balanced { background: #1a73e8; }


  /* 2. Reserve Group */
  #reserveGroup {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0; 
    margin-right: 30px; 
  }
  
  /* RESERVE DISPLAY FIX */
  #reserveDisplayContainer {
    color: white; 
    padding: 8px 15px; 
    border-radius: 5px;
    flex-shrink: 0; 
    background: linear-gradient(to bottom, #1a73e8, #1565c0); 
    font-weight: 700; 
  }
  
  /* Reserve dollar amount must be the same bold as the title (fixed) */
  #reserveDisplayContainer span {
      font-weight: 700; 
      color: white; 
  }
  
  /* Action Buttons */
  .main-actions-group {
      display: flex;
      gap: 10px;
      flex-grow: 1; 
      justify-content: center; 
      flex-shrink: 0;
  }
  .button { 
    color: white; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    font-weight: 700; 
    font-size: 0.9em; 
    padding: 10px 15px; 
    flex-shrink: 0; 
    min-width: 150px; 
    transition: background 0.2s ease;
    /* FIX: CENTERING TEXT on buttons */
    display: flex; 
    align-items: center;
    justify-content: center; /* Ensures text is centered horizontally */
    text-align: center;
  }
  .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
  }
  
  /* --- BUTTON COLOR RESTORATION --- */
  #nextYearBtn { 
      background: linear-gradient(to bottom, #4CAF50, #2E8B57) !important;
  }
  #reserveBtn, #useReserveBtn { 
      background: linear-gradient(to bottom, #1a73e8, #1565c0) !important;
      min-width: 120px;
      color: white; 
      font-weight: 700 !important; 
  }
  #resetBtn { 
      background: linear-gradient(to bottom, #FF5733, #C70039) !important; 
      margin-left: auto; 
      min-width: 100px;
  }

  /* Guidance Text (Always Full Width at Bottom) */
  #guidanceText { 
    color:#aaa; 
    font-weight:400;
    text-align:center;
    font-size:0.9em;
    padding: 5px 0 10px; 
    width: 100%; 
    flex-shrink: 0;
  }
  
  /* --- Mobile Adjustments (Floater Fixes Applied Here) --- */
  @media (max-width: 850px) {
    /* --- FLOATER SIZE REDUCTION --- */
    .floating-controls { 
        padding: 5px 10px 0; /* Reduced top padding */
    }
    .floating-action-row {
        flex-wrap: wrap; 
        gap: 8px; 
        overflow-x: hidden; 
        padding-bottom: 5px; 
    }
    .section { 
        padding-bottom: 240px; /* Increased clearance for smaller floater */
        padding-left: 15px;
        padding-right: 15px;
    }
    
    /* Mobile-specific order and width */
    #statusDisplay { 
        order: 1; 
        margin: 0; 
        flex: 1 1 100%; /* Ensure status display is always full width */
    } 
    
    /* --- RESERVE GROUP FIX --- */
    #reserveGroup { 
        order: 2; 
        margin: 0; 
        width: 100%; /* Force reserve group to full width */
        flex-wrap: wrap; 
        justify-content: flex-start; /* Align contents left */
        gap: 8px; /* Consistent gap */
    }
    
    /* RESERVE DISPLAY: MUST BE 100% WIDTH */
    #reserveDisplayContainer { 
        flex: 1 1 100%; /* Force display container to be full width */
        margin-bottom: 0; /* Remove extra space below display */
        text-align: center; 
    }

    /* RESERVE BUTTONS: MUST BE 100% WIDTH, STACKED */
    #reserveBtn, #useReserveBtn { 
        flex: 0 0 100%; /* CRITICAL: Fixed basis to 100% to ensure clean stacking and full width */
        min-width: unset; 
        justify-content: center; /* Reinforce horizontal centering */
    }
    
    /* Main Actions Group: FIX: Sets Proceed and Reset side-by-side with consistent sizing */
    .main-actions-group { 
        order: 3; 
        flex-direction: row; 
        width: 100%; 
        gap: 10px; 
        justify-content: space-between;
    }
    .main-actions-group .button {
        min-width: unset; 
        flex: 1 1 50%; 
    }
    
    .button { min-width: auto; }
    #guidanceText { padding: 5px 0 10px; }
    
    /* Ensure small screen grid still works */
    #projectButtons > .projects {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    /* Mobile-specific adjustments for the Tax Adjuster row */
    #taxAdjusterContainer {
        flex-direction: column; 
        align-items: center;
        gap: 10px;
    }
    #taxAdjusterContainer input[type="range"] {
        order: 2; /* Put slider in the middle */
        width: 100%;
    }
    #taxAdjusterContainer canvas {
        order: 1; /* Put Annual Rate at the top */
        margin-right: 0 !important;
    }
    #cumulativeTaxDisplay {
        order: 3; /* Put Net Change at the bottom */
    }
    #cumulativeTaxDisplay canvas {
        margin-right: 0 !important;
    }
  }
</style>
</head>
<body>

<div class="section">
  <h1>Balance Your City's Budget</h1>
  
  <div class="disclaimer">
      ⚠️ <strong>IMPORTANT DISCLAIMER:</strong> This is a financial <strong>simulation</strong> intended for educational and engagement purposes only. 
      The numbers, costs, and service impacts are simplified estimates and <strong>do not reflect the actual complex financial plan or budget reality of any municipality.</strong>
  </div>

  <p class="intro-text">Welcome to the Brooks Budget Simulator! Adjust taxes, select capital projects, and manage department budgets to balance the city’s finances while meeting community needs. </p>
  
  <div class="progress-bar" id="yearBar"></div>

  <!-- NEW SECTION: PERSONAL PROPERTY ASSESSMENT -->
  <h3 id="personalAssessmentSection">Your Property Assessment</h3>
  <div class="slider-card" id="personalAssessmentCard">
      <!-- Content generated by renderPersonalAssessment() -->
  </div>

  <!-- TAX ADJUSTER CARD - MODIFIED STRUCTURE -->
  <div class="slider-card">
    <!-- REPLACED div with CANVAS: Annual Tax Adjustment -->
    <canvas id="canvas-tax-annual" width="80" height="80"></canvas>
    
    <div class="slider-content" style="width: 100%;">
      <label><strong>Annual Property Tax Adjustment</strong></label>
      <p style="font-size:0.9em;color:#555;margin-bottom:10px;">The slider is the tax change for *this year*. A **3%** adjustment covers inflation.</p>
      
      <!-- Container for ALL Tax elements: Annual Circle, Slider, Cumulative Display -->
      <div id="taxAdjusterContainer"> 
          <!-- Slider Input (Center) -->
          <input type="range" id="taxRate" min="0" max="25" value="3">
          
          <!-- Cumulative Tax Group (Right: Circle + Label) -->
          <div id="cumulativeTaxDisplay">
              <div class="tax-label">Net Change</div>
              <!-- REPLACED div with CANVAS: Cumulative Tax Adjustment -->
              <canvas id="canvas-tax-cumulative" width="60" height="60"></canvas> 
          </div>
      </div>
    </div>
  </div>
  
  <h3>Capital Projects Selection</h3>
  <p style="font-size:0.9em;color:#555;margin-bottom:15px;">Capital project selections were taken from resident feedback in the 2026 Brooks Budget Survey.</p>
  <div id="projectButtons">
      </div>

  <h3>Department Budget Adjustments</h3>
  <div id="departmentSliders"></div>
</div>

<div class="floating-controls">
    <div class="floating-action-row">
        <div id="statusDisplay" class="status balanced">Balance: $0</div>

        <div id="reserveGroup">
            <div id="reserveDisplayContainer">Reserve Fund: $<span id="reserveDisplay">0</span></div> 
            <button class="button" id="useReserveBtn" disabled>Use Reserve</button>
            <button class="button" id="reserveBtn" style="display:none;">Add Surplus to Reserve</button>
        </div>
        
        <!-- Main Actions Group: Order is Proceed then Reset, which naturally puts Reset at the bottom on mobile -->
        <div class="main-actions-group">
            <button class="button" id="nextYearBtn" style="display:none;">Proceed to Next Year</button>
            <button class="button" id="resetBtn">Reset Year</button>
        </div>

    </div>

  <p id="guidanceText"></p>
</div>

<script>
  // --- DOM Elements ---
  const taxRateInput = document.getElementById('taxRate');
  // Changed references from DIVs to CANVAS elements
  const taxAnnualCanvas = document.getElementById('canvas-tax-annual'); 
  const taxCumulativeCanvas = document.getElementById('canvas-tax-cumulative'); 
  const projectButtonsContainer = document.getElementById('projectButtons');
  const departmentSlidersContainer = document.getElementById('departmentSliders');
  const statusDisplay = document.getElementById('statusDisplay');
  const reserveDisplay = document.getElementById('reserveDisplay');
  const reserveBtn = document.getElementById('reserveBtn');
  const useReserveBtn = document.getElementById('useReserveBtn');
  const nextYearBtn = document.getElementById('nextYearBtn');
  const resetBtn = document.getElementById('resetBtn'); 
  const guidanceText = document.getElementById('guidanceText');
  
  // --- Game Constants and Initial State ---
  const STARTING_OPERATING_COST = 31500000;
  const BASE_REVENUE = 30000000; // This leaves the required $1.5M shortfall (31.5M - 30M)
  const REVENUE_PER_TAX_POINT = 500000; 
  const DEPT_ADJUSTMENT_PER_PERCENT = 25000; 
  const MAX_YEARS = 4;
  
  // --- NEW PERSONAL FINANCE CONSTANTS ---
  const ASSESSMENT_INCREASE_RATE = 0.05; // 5% annual assessment increase
  
  // INITIAL MILL RATE: Calculated based on user's input: $5,900 tax bill on $513,000 assessment
  const INITIAL_MILL_RATE = 11.491; 

  // TAX BREAKDOWN CONSTANTS (per dollar)
  const TAX_BREAKDOWN = {
      MUNICIPAL: 0.77,
      EDUCATION: 0.22,
      NEWELL: 0.01,
  };

  const departmentBaselines = {}; 

  const projects = [
    // --- REQUIRED PROJECTS ---
    { name: "Server Upgrade", cost: 1000000, deadline: 1, type: 'required' }, 
    { name: "New Fire Truck", cost: 1000000, deadline: 2, type: 'required' }, 
    { name: "New Waste Facility", cost: 5000000, deadline: 3, type: 'required' }, 
    { name: "Cassils Road Twinning & Upgrade", cost: 7000000, deadline: 4, type: 'required' }, 
    
    // --- ADDITIONAL PROJECTS ---
    { name: "Water Treatment Upgrade", cost: 4000000, type: 'additional' },
    { name: "New Recreation Center", cost: 2000000, type: 'additional' },
    { name: "Major Road Improvements", cost: 3500000, type: 'additional' },
    { name: "Library Renovation", cost: 1500000, type: 'additional' },
    { name: "Fire Station Upgrade", cost: 2500000, type: 'additional' },
    { name: "Community Water Park", cost: 1750000, type: 'additional' },
    { name: "New Sports Complex", cost: 3000000, type: 'additional' },
    { name: "Public Transit Expansion", cost: 2250000, type: 'additional' },
    { name: "Bike Path Network", cost: 1250000, type: 'additional' },
    { name: "City Hall Renovation", cost: 3500000, type: 'additional' },
    { name: "Municipally Owned Mall", cost: 2750000, type: 'additional' }
  ];
  
  const departments = [
    "RCMP/Policing Services", "Snow & Ice Removal", "Road & Pavement Maintenance",
    "Parks & Playgrounds", "Recreation Facilities & Programs", "Community Development",
    "Storm Water Maintenance", "Municipal Public Safety", "Athletic Fields"
  ];
  
  const scenarios = {
      // ... (scenarios object remains unchanged)
      "RCMP/Policing Services": {
          cuts: ["Minor Cut (-10%): Non-emergency response times increase slightly. Community events funding is reduced.","Moderate Cut (-20%): Police patrols are visibly less frequent. Community engagement programs are cancelled.","Severe Cut (-30%): Significant rise in property crime due to fewer patrols. Only highest priority calls are actioned quickly.","Drastic Cut (-40%): Police Station staff are reduced to minimal levels. Non-violent crime investigations are often suspended.","Extreme Cut (-50%): Patrols are severely limited. Emergency response for anything but violent crime is heavily delayed. Officer morale plummets."],
          increases: ["Minor Increase (+10%): Increased police visibility and slightly faster non-emergency response.","Moderate Increase (+20%): New proactive community engagement programs and neighborhood watch support are launched.","High Increase (+30%): Significant investment in technology and training. Crime rates in hot spots begin to drop.","Major Increase (+40%): Full community policing model adopted. Dedicated bike patrols established downtown.","Extreme Increase (+50%): A new satellite station is built in a growing area. Fastest emergency response times in the region."]
      },
      "Snow & Ice Removal": {
          cuts: ["Minor Cut (-10%): Residential streets are cleared slower than usual. Salt usage is slightly reduced.","Moderate Cut (-20%): Secondary and residential routes are often only cleared after major storms. Icy conditions persist.","Severe Cut (-30%): Plowing priority drops severely. Side roads are often ignored for days. Travel times significantly increase.","Drastic Cut (-40%): Only main arterials are cleared promptly. Many roads become single-lane, deeply rutted ice tracks.","Extreme Cut (-50%): Minimal clearance. Snow clearing is effectively limited to the primary highway through town. City gridlock is common."],
          increases: ["Minor Increase (+10%): Residential streets are cleared more quickly after storms.","Moderate Increase (+20%): Enhanced anti-icing methods used before storms. Snow removal equipment is upgraded.","High Increase (+30%): All roads cleared within 24 hours of a major snowfall. Dedicated sidewalk clearing team established.","Major Increase (+40%): New heavy equipment purchased. Proactive clearing begins immediately upon first flake.","Extreme Increase (+50%): The city is prepared for record snowfalls. Service levels are the best in the province."]
      },
      "Road & Pavement Maintenance": {
          cuts: ["Minor Cut (-10%): Routine pavement maintenance deferred. Pothole repair response time increases to over a week.","Moderate Cut (-20%): Pothole repair budget slashed. Roads visibly deteriorate, leading to more complaints.","Severe Cut (-30%): Major resurfacing projects are completely halted. The structural integrity of several roads is compromised.","Drastic Cut (-40%): Potholes are only fixed if they are deemed a 'major hazard.' Vehicle damage claims against the city skyrocket.","Extreme Cut (-50%): Road maintenance limited to emergency fixes. Many side roads become barely drivable, resembling gravel roads."],
          increases: ["Minor Increase (+10%): Pothole response time drops to 72 hours. Proactive crack sealing begins.","Moderate Increase (+20%): Potholes are fixed within 48 hours. Aggressive proactive pavement management implemented.","High Increase (+30%): Major resurfacing is prioritized. Road network health rating significantly improves.","Major Increase (+40%): New, quieter asphalt materials used in residential areas. A full-time sidewalk repair crew is established.","Extreme Increase (+50%): The city achieves the highest road quality rating in the region. All roads are inspected monthly."]
      },
      "Parks & Playgrounds": {
          cuts: ["Minor Cut (-10%): Grass is cut slightly less often. Water conservation measures lead to duller green spaces.","Moderate Cut (-20%): Grass cutting frequency reduced significantly. Weeds and pest problems become visible in parks.","Severe Cut (-30%): Landscape beds are neglected. Routine maintenance on some playground equipment is delayed, raising minor safety concerns.","Drastic Cut (-40%): Several smaller parks are designated for 'minimal maintenance.' Public washrooms in parks are closed for the season.","Extreme Cut (-50%): Only essential safety checks are performed. Parks become overgrown and playgrounds start to look run-down."],
          increases: ["Minor Increase (+10%): Parks receive more frequent attention. New flower planting efforts begin.","Moderate Increase (+20%): New trees planted throughout the city. All playgrounds receive minor upgrades and fresh mulch.","High Increase (+30%): Two major parklands are fully renovated. The city wins a 'Green City' award.","Major Increase (+40%): A new splash park is constructed. Park security patrols are increased.","Extreme Increase (+50%): All playgrounds are replaced with state-of-the-art equipment. New public art installed in parks."]
      },
      "Recreation Facilities & Programs": {
          cuts: ["Minor Cut (-10%): Facility hours are cut back slightly. Less popular programs are cancelled.","Moderate Cut (-20%): Arena and pool hours are reduced during off-peak times. Fee-based program costs increase.","Severe Cut (-30%): Facility maintenance deferred. A major recreation center wing is closed permanently to save costs.","Drastic Cut (-40%): A community pool or arena is permanently shut down. Access to recreation facilities becomes limited.","Extreme Cut (-50%): All non-essential programs are cancelled. Remaining facilities are run on skeletal staff, with severe hour restrictions."],
          increases: ["Minor Increase (+10%): Extended operating hours for facilities. New instructional classes added.","Moderate Increase (+20%): Equipment in the gym and pool is upgraded. Free access programs are launched for low-income residents.","High Increase (+30%): A major renovation of one facility is funded. More popular evening and weekend program slots are opened.","Major Increase (+40%): Funding provided for local sports teams to host regional events. New youth programs are developed.","Extreme Increase (+50%): A new state-of-the-art multi-use recreation dome is designed and construction begins."]
      },
      "Community Development": {
          cuts: ["Minor Cut (-10%): Support for non-profit and arts organizations is slightly reduced.","Moderate Cut (-20%): Grants to non-profits are cut. Staff support for local business events is eliminated.","Severe Cut (-30%): Business incentive programs are suspended. Downtown revitalization efforts stall.","Drastic Cut (-40%): The department focuses only on mandatory permitting. Economic development efforts cease.","Extreme Cut (-50%): The Community Development department is merged with another, resulting in minimal activity beyond processing forms."],
          increases: ["Minor Increase (+10%): New networking events are created to support small businesses.","Moderate Increase (+20%): A new business retention and attraction campaign is launched.","High Increase (+30%): A downtown beautification and incentive fund is established, attracting new investment.","Major Increase (+40%): Funding is secured to attract a major employer to the city.","Extreme Increase (+50%): A new innovation hub is built, cementing the city as a regional economic center."]
      },
      "Storm Water Maintenance": {
          cuts: ["Minor Cut (-10%): Routine storm drain cleaning schedule is stretched out.","Moderate Cut (-20%): Minor flooding becomes more frequent during heavy rain. Residential complaints rise.","Severe Cut (-30%): Sewer and drainage system maintenance is minimal. Increased risk of basement flooding in older neighborhoods.","Drastic Cut (-40%): System fails to handle moderate storms. Major intersections flood, causing road closures.","Extreme Cut (-50%): Focus is strictly on system repair after a failure. Infrastructure damage from constant flooding is widespread."],
          increases: ["Minor Increase (+10%): Proactive monitoring of drainage systems is implemented.","Moderate Increase (+20%): Accelerated maintenance schedule cleans all drains twice per year.","High Increase (+30%): New infrastructure projects are funded to improve drainage capacity in known problem areas.","Major Increase (+40%): The city begins converting some drainage areas into naturalized bio-swales, improving water quality.","Extreme Increase (+50%): A major, city-wide storm water infrastructure upgrade is initiated, eliminating flood risk."]
      },
      "Municipal Public Safety": {
          cuts: ["Minor Cut (-10%): Bylaw enforcement response time increases. Fewer staff for proactive fire code inspections.","Moderate Cut (-20%): Bylaw enforcement is complaint-driven only. Visible disorder (e.g., illegal dumping) increases.","Severe Cut (-30%): Building permit processing is significantly delayed. Staff reductions mean fewer safety and sanitation inspections.","Drastic Cut (-40%): Public safety is compromised due to lack of fire, building, and health inspections. Unsafe living conditions may arise.","Extreme Cut (-50%): The bylaw office is barely functional. The city loses control over nuisance and safety issues."],
          increases: ["Minor Increase (+10%): Bylaw patrols increase. Proactive inspections reduce visible disorder.","Moderate Increase (+20%): Faster building permit approval process. All essential safety inspections are completed on time.","High Increase (+30%): Dedicated public safety teams patrol parks and high-traffic areas, deterring nuisance behavior.","Major Increase (+40%): Investment in technology for monitoring and enforcement. A new community mediation service is launched.","Extreme Increase (+50%): The city is recognized for its high standard of public order and safety compliance."]
      },
      "Athletic Fields": {
          cuts: ["Minor Cut (-10%): Field lining is less crisp. Minor weed control is deferred.","Moderate Cut (-20%): The quality of turf and playing surfaces deteriorates. Less maintenance leads to minor cancellations.","Severe Cut (-30%): Fields are poorly maintained and potentially unsafe for major sports. Teams must play on suboptimal surfaces.","Drastic Cut (-40%): Maintenance stops during the off-season. Several fields are closed permanently due to poor condition.","Extreme Cut (-50%): All non-essential maintenance ceases. Athletic fields become glorified open green space, unplayable for organized sports."],
          increases: ["Minor Increase (+10%): Fields are better prepared before the season. Improved irrigation leads to greener turf.","Moderate Increase (+20%): Fields are maintained to a high standard, attracting local sports leagues.","High Increase (+30%): New high-quality artificial turf installed on two major fields.","Major Increase (+40%): The city attracts regional sports tournaments, boosting local business.","Extreme Increase (+50%): New lighting installed on all major fields, dramatically extending playing hours."]
      }
  };


  // --- Game State ---
  let currentYear = 1;
  let selectedProjects = [];
  let completedProjects = [];
  let reserve = 0;
  let shortfall = 0;
  let operatingCost = STARTING_OPERATING_COST; 
  let reserveContribution = 0; 
  let bankedSurplus = 0; // Tracks surplus moved to reserve in the current year.
  // RENAMED: totalNominalTaxRate now tracks the total cumulative percentage increase since Year 1 start (starting at 0)
  let totalNominalTaxRate = 0; 
  
  // --- NEW PERSONAL FINANCE STATE ---
  let userAssessment = 513000; // Initial value based on user input
  let userTaxBill = 5900;     // Initial value based on user input
  let lastYearTaxBill = 5900; // The tax bill accepted when moving to next year (baseline for current year)

  // Initialize department baselines
  departments.forEach(dept => departmentBaselines[dept] = 100);

  // --- Utility Functions ---
  function formatCurrency(amount) {
    return `${Number(amount).toLocaleString(undefined, { minimumFractionDigits: 0 })}`;
  }
  
  function formatCurrencyDisplay(amount) {
      return `$${Number(amount).toLocaleString(undefined, { minimumFractionDigits: 0 })}`;
  }
  
  /**
   * Calculates the components of the property tax bill based on fixed local percentages.
   * @param {number} totalTaxBill The total proposed tax bill amount.
   * @returns {{muni: number, edu: number, newell: number, total: number}} Breakdown amounts.
   */
  function getTaxBreakdown(totalTaxBill) {
      // Note: Math.round used to keep components in whole dollars.
      const muni = Math.round(totalTaxBill * TAX_BREAKDOWN.MUNICIPAL);
      const edu = Math.round(totalTaxBill * TAX_BREAKDOWN.EDUCATION);
      // Ensure the Newell amount makes the total sum exactly equal to totalTaxBill
      const newell = totalTaxBill - muni - edu; 
      
      return {
          muni: muni,
          edu: edu,
          newell: newell,
          total: totalTaxBill
      };
  }
  
  /**
   * Draws a simple filled circle on a canvas with text in the center.
   * This replaces the old DIV/CSS based circles for consistent sizing.
   * @param {string} canvasId - The ID of the canvas element.
   * @param {string} text - The text to display (e.g., "110%" or "5%").
   * @param {string} color - The fill color of the circle.
   */
  function drawFilledCircle(canvasId, text, color) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const size = canvas.width;
      const center = size / 2;
      const radius = center * 0.9; 

      // Clear the canvas
      ctx.clearRect(0, 0, size, size);

      // Draw the background circle
      ctx.beginPath();
      ctx.arc(center, center, radius, 0, 2 * Math.PI);
      ctx.fillStyle = color;
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 5;
      ctx.fill();

      // Draw the white text in the center
      ctx.fillStyle = '#ffffff';
      
      // Determine font size based on canvas size
      let fontSize = size === 80 ? 18 : 14; 
      
      // CRITICAL FIX: Ensure Montserrat is always used for canvas text
      ctx.font = `bold ${fontSize}px Montserrat`; 
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowBlur = 0; // Disable shadow for text
      ctx.fillText(text, center, center);
  }

  /**
   * Calculates the raw balance for the current year based on current slider inputs.
   * Returns: Cost - Revenue (Positive = Shortfall, Negative = Surplus)
   */
  function calculateRawBalance() {
      const tax = parseFloat(taxRateInput.value);
      // 1. Calculate Revenue
      // Revenue is calculated using the annual tax rate input value (e.g., if input is 5, revenue increases by 5 points)
      const revenue = BASE_REVENUE + (REVENUE_PER_TAX_POINT * tax); 
      
      // 2. Calculate Costs (Projects and Department adjustments for the current year)
      const projectCost = selectedProjects.reduce((sum, i) => sum + projects[i].cost, 0);
      
      let currentYearDeptAdjustment = 0;
      departments.forEach(deptName => {
        const id = deptName.replace(/\s|&/g, "");
        const slider = document.getElementById(id);
        if (slider) {
            const val = parseInt(slider.value);
            // Department adjustment represents a cost increase/decrease for the current year relative to 100% baseline
            currentYearDeptAdjustment += DEPT_ADJUSTMENT_PER_PERCENT * (val - 100);
        }
      });
      
      let totalCost = operatingCost + projectCost + currentYearDeptAdjustment;
      
      // Returns Cost - Revenue
      return totalCost - revenue; 
  }
  
  /**
   * Calculates the initial Year 1 tax bill based on the current user assessment.
   * This is used to establish the baseline before any annual city tax rate adjustments.
   * @param {number} assessment The user's home assessment value.
   * @returns {number} The baseline property tax bill.
   */
  function calculateInitialTaxBill(assessment) {
      // Tax Bill = Assessment * (Mill Rate / 1000)
      if (assessment > 0) {
          return Math.round((assessment / 1000) * INITIAL_MILL_RATE);
      }
      return 0;
  }


  // --- Render Functions ---
  function renderYearBar() {
    const yearBar = document.getElementById('yearBar');
    yearBar.innerHTML = "";
    for (let i = 1; i <= MAX_YEARS; i++) {
      const yearEl = document.createElement("div");
      yearEl.className = "year";
      yearEl.textContent = `Year ${i}`;
      if (i === currentYear) {
        yearEl.classList.add("active");
      } else if (i < currentYear) {
        yearEl.classList.add("completed");
      }
      yearBar.appendChild(yearEl);
    }
  }

  function renderPersonalAssessment() {
      const card = document.getElementById('personalAssessmentCard');
      const isLocked = currentYear > 1;
      const displayAssessment = userAssessment; // Use current state value

      card.innerHTML = `
          <div class="slider-content" style="width: 100%;">
              <p style="font-size:0.9em;color:#555;margin-bottom:10px;">
                  Set your residential property's assessed market value. This value will increase by 
                  <strong>${(ASSESSMENT_INCREASE_RATE * 100).toFixed(0)}%</strong> annually to simulate market growth.
              </p>
              
              <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                  <label for="initialAssessmentInput" style="font-weight: 700; flex-shrink: 0;">Home Assessment:</label>
                  <input type="number" id="initialAssessmentInput" min="50000" step="10000" value="${displayAssessment}" 
                         style="padding: 8px; border: 1px solid #ccc; border-radius: 5px; flex-grow: 1; font-weight: 600;" 
                         ${isLocked ? 'disabled' : ''}>
              </div>
              
              <div id="assessmentStatus" style="font-size:1.1em; font-weight: 700; color: #1a73e8; padding-top: 5px; border-top: 1px dashed #ddd;">
                  Current Assessment: ${formatCurrencyDisplay(displayAssessment)}
              </div>
              
              <div id="personalTaxBillDisplay" style="margin-top: 15px; font-size:1.2em; font-weight: 700; color: #C70039;">
                  Approximate Property Tax Bill (Proposed): $0
              </div>
              
              <!-- Placeholder for Tax Breakdown -->
              <div id="taxBreakdownDisplay" class="tax-breakdown" style="margin-top: 10px;"></div>
          </div>
      `;
      
      const inputEl = document.getElementById('initialAssessmentInput');
      if (inputEl && !isLocked) {
          // Add event listener only if not locked (i.e., in Year 1)
          inputEl.addEventListener('input', (e) => {
              let newVal = parseInt(e.target.value) || 0;
              if (newVal < 50000) newVal = 50000;
              userAssessment = newVal;
              
              // Recalculate baseline tax bill when assessment changes in Year 1
              lastYearTaxBill = calculateInitialTaxBill(userAssessment);
              userTaxBill = lastYearTaxBill; 
              
              document.getElementById('assessmentStatus').textContent = `Current Assessment: ${formatCurrencyDisplay(userAssessment)}`;
              // Reset commitment flags on any valid input change 
              bankedSurplus = 0; 
              reserveContribution = 0;
              updateStatus(); // Recalculate tax bill display
          });
      }
      
      // Update the assessment status to include the next year projection only after Y1
      if (currentYear > 1) {
           document.getElementById('assessmentStatus').textContent = 
                `Current Assessment: ${formatCurrencyDisplay(userAssessment)} | Projected Next Year: ${formatCurrencyDisplay(Math.round(userAssessment * (1 + ASSESSMENT_INCREASE_RATE)))}`;
      }
  }

  function updateProgressBar() {
    document.querySelectorAll(".year").forEach((el, index) => {
      el.classList.remove("active", "completed");
      if (index + 1 === currentYear) {
        el.classList.add("active");
      } else if (index + 1 < currentYear) {
        el.classList.add("completed");
      }
    });
  }

  function updateTaxSliderColor() { 
    const taxValue = parseInt(taxRateInput.value);
    
    // --- 1. ANNUAL TAX DISPLAY (Left Canvas) ---
    taxAnnualCanvas.textContent = `${taxValue}%`;
    let colorAnnual;
    
    // FIX: Reverse logic for Tax Rate (Green for drop < 3%, Red for hike > 3%)
    if (taxValue < 3) {
      colorAnnual = "#4CAF50"; // Green (Taxpayer benefit)
      taxRateInput.style.background = '#4CAF50'; 
    } else if (taxValue > 3) {
      colorAnnual = "#FF5733"; // Red (Taxpayer detriment)
      taxRateInput.style.background = '#FF5733';
    } else {
      colorAnnual = "#1a73e8"; // Blue (Balanced/Inflation match)
      taxRateInput.style.background = '#1a73e8';
    }
    
    // Draw the Annual Canvas Circle
    drawFilledCircle('canvas-tax-annual', `${taxValue}%`, colorAnnual);

    // --- 2. CUMULATIVE TAX DISPLAY (Right Canvas, Net Change) ---
    const totalNominalRate = totalNominalTaxRate + taxValue; 
    const colorCumulative = "#455a64"; // Neutral Gray for cumulative tracker
    
    // Draw the Cumulative Canvas Circle
    drawFilledCircle('canvas-tax-cumulative', `${totalNominalRate}%`, colorCumulative);
  }
  
  function createProjectButton(project, index) {
      const btn = document.createElement("button");
      btn.className = "project-btn";
      
      let content = `<div class="project-title">${project.name}</div>
                      <div class="project-cost">${formatCurrencyDisplay(project.cost)}</div>`;

      if (project.type === 'required') {
          content += `<div class="required-text">CRITICAL - DUE BY YR ${project.deadline}</div>`;
          btn.classList.add("required"); 
      }
      btn.innerHTML = content;

      if (completedProjects.includes(index)) {
          btn.classList.add("completed");
          btn.disabled = true;
      } else {
          if (selectedProjects.includes(index)) {
              btn.classList.add("selected");
          }
          
          btn.onclick = () => {
              // PENALTY IF USER CLICKS A PROJECT WHILE COMMITTED
              handleCommitmentOverride(); 
              
              btn.classList.toggle("selected");
              if (btn.classList.contains("selected")) {
                  selectedProjects.push(index);
              } else {
                  selectedProjects = selectedProjects.filter(i => i !== index);
              }
              // Reset commitment flags on any valid input change 
              bankedSurplus = 0; 
              reserveContribution = 0;
              
              createProjectButtons(); // Re-render projects to ensure visual state is correct
              updateStatus();
          };
      }
      return btn;
  }

  function createProjectButtons() {
    projectButtonsContainer.innerHTML = "";
    
    const projectsDiv = document.createElement('div');
    projectsDiv.className = 'projects';
    
    projects.forEach(project => {
        const index = projects.indexOf(project);
        projectsDiv.appendChild(createProjectButton(project, index));
    });
    projectButtonsContainer.appendChild(projectsDiv);
  }

  function createDepartmentSliders() {
    departmentSlidersContainer.innerHTML = "";
    
    departments.forEach(deptName => {
      const id = deptName.replace(/\s|&/g, "");
      
      const card = document.createElement("div");
      card.className = "slider-card";
      
      let sliderValue = departmentBaselines[deptName];
      
      // REPLACED DIV with CANVAS
      card.innerHTML = `
        <canvas id="canvas-${id}" width="80" height="80"></canvas>
        <div class="slider-content">
          <label><strong>${deptName}</strong> <span style="font-weight: normal; color: #666;">(Baseline: ${departmentBaselines[deptName]}%)</span></label>
          <input type="range" min="50" max="150" value="${sliderValue}" step="10" id="${id}">
          <div id="impact-${id}" style="font-size:0.9em;color:#555; margin-top: 10px;">No change to service levels.</div>
        </div>
      `;
      departmentSlidersContainer.appendChild(card);

      const slider = document.getElementById(id);
      updateSliderVisuals(slider); 
      
      slider.addEventListener("input", () => {
        // --- COMMITMENT PENALTY CHECK ---
        handleCommitmentOverride(); 
        
        updateSliderVisuals(slider);
        // Reset commitment flags
        bankedSurplus = 0; 
        reserveContribution = 0;
        
        createProjectButtons(); 
        updateStatus();
      });
    });
  }
  
  function getImpactText(deptName, percentage) {
      const scenario = scenarios[deptName];
      if (!scenario) return "No change to service levels.";

      const offset = percentage - 100;
      
      if (offset < 0) {
          const index = Math.abs(offset) / 10 - 1;
          if (index >= 0 && index < scenario.cuts.length) {
              return scenario.cuts[index];
          }
      } else if (offset > 0) {
          const index = offset / 10 - 1;
          if (index >= 0 && index < scenario.increases.length) {
              return scenario.increases[index];
          }
      } 
      
      return "No change to service levels.";
  }

  function updateSliderVisuals(slider) {
      const deptName = departments.find(d => d.replace(/\s|&/g, "") === slider.id);
      const id = slider.id;
      const val = parseInt(slider.value);
      const canvasId = `canvas-${id}`;
      const impact = document.getElementById(`impact-${id}`);
      
      let color;
      
      // Department Logic: Red for cuts (<100%), Green for increases (>100%)
      if (val < 100) {
        color = "#FF5733"; // Red
        slider.style.background = '#FF5733';
      } else if (val > 100) {
        color = "#4CAF50"; // Green
        slider.style.background = '#4CAF50';
      } else {
        color = "#1a73e8"; // Blue
        slider.style.background = '#1a73e8';
      }
      
      // Draw the Canvas Circle
      drawFilledCircle(canvasId, `${val}%`, color);
      
      if (deptName) {
        impact.innerHTML = getImpactText(deptName, val);
      }
  }
  
  // --- COMMITMENT PENALTY FUNCTION ---
  function handleCommitmentOverride() {
    if (bankedSurplus > 0) {
        // PENALTY: Deduct the banked amount from the reserve
        reserve -= bankedSurplus; 
        
        reserve = Math.max(0, reserve); 
        
        guidanceText.innerHTML = `❌ <strong>COMMITMENT BROKEN!</strong> The previously banked surplus of 
                                ${formatCurrencyDisplay(bankedSurplus)} has been removed from your reserve. 
                                Re-balance the budget from scratch.`;
        
        // This is necessary to clear the old commit and allow the new values to calculate shortfall
        bankedSurplus = 0; 
        reserveContribution = 0;
    } 
  }

  // --- Game Logic ---
  function updateStatus() {
    updateTaxSliderColor();
    
    const isCommitted = bankedSurplus > 0; 

    // Calculate raw balance (Cost - Revenue)
    const rawBalance = calculateRawBalance(); 
    
    // Calculated shortfall is the raw deficit if Cost > Revenue
    const calculatedShortfall = Math.max(0, rawBalance);
    // Calculated surplus is the raw surplus if Revenue > Cost
    const calculatedSurplus = Math.abs(Math.min(0, rawBalance)); 

    let currentSurplus = 0;
    
    if (calculatedShortfall > 0) {
      // If there is a shortfall, we must cover it.
      
      let netShortfall = calculatedShortfall - reserveContribution;
      
      shortfall = Math.max(0, netShortfall); // The remaining deficit
      currentSurplus = 0; 
      
    } else {
      // If there is no shortfall (surplus or balanced)
      shortfall = 0;
      
      // If we had a previous reserve contribution, we credit it back since it wasn't needed
      let totalSurplus = calculatedSurplus + reserveContribution; 
      reserveContribution = 0; // Reset contribution as it was unnecessary
      
      // The overall surplus is the calculated raw surplus 
      currentSurplus = totalSurplus; 
    }
    
    // 5. Determine the final display values after reserve actions (contribution/banked)
    let displayShortfall = shortfall;
    let displaySurplus = Math.max(0, currentSurplus - bankedSurplus); 
    
    // --- Update Displays using the final display variables ---
    statusDisplay.innerHTML = displayShortfall > 0 ? 
        `Shortfall: ${formatCurrencyDisplay(displayShortfall)}` : 
        (displaySurplus > 0 ? `Surplus: ${formatCurrencyDisplay(displaySurplus)}` : `Balance: $0`);
        
    statusDisplay.classList.remove('shortfall', 'surplus', 'balanced');
    if (displayShortfall > 0) {
        statusDisplay.classList.add('shortfall');
    } else if (displaySurplus > 0) {
        statusDisplay.classList.add('surplus');
    } else {
        statusDisplay.classList.add('balanced');
    }

    reserveDisplay.textContent = formatCurrency(reserve);

    // reserveBtn is only visible and enabled if there is a displaySurplus remaining AND not committed
    reserveBtn.style.display = (displaySurplus > 0 && !isCommitted) ? "inline-block" : "none";
    reserveBtn.disabled = isCommitted; 
    
    // useReserveBtn is enabled if there is a shortfall AND reserve is available AND not committed
    useReserveBtn.style.display = (displayShortfall > 0 && reserve > 0 && !isCommitted) ? "inline-block" : "none";
    useReserveBtn.disabled = isCommitted; 

    // nextYearBtn is only visible if shortfall is 0 (balanced or surplus)
    nextYearBtn.style.display = displayShortfall === 0 ? "inline-block" : "none";
    
    // --- PERSONAL FINANCE DISPLAY UPDATE ---
    const currentTaxRate = parseInt(taxRateInput.value);
    const taxChangeMultiplier = 1 + (currentTaxRate / 100);
    
    let approximateTaxBill = 0;
    let taxBillEl = document.getElementById('personalTaxBillDisplay');
    let assessmentStatusEl = document.getElementById('assessmentStatus');
    let taxBreakdownEl = document.getElementById('taxBreakdownDisplay');

    if (taxBillEl && assessmentStatusEl && userAssessment > 0) {
        // Tax bill is always based on the 'lastYearTaxBill' baseline multiplied by the current year's city tax change
        let baselineTaxBill = lastYearTaxBill;

        // Calculate the proposed bill
        approximateTaxBill = Math.round(baselineTaxBill * taxChangeMultiplier); 
        
        taxBillEl.innerHTML = `
            Approximate Property Tax Bill (Proposed): 
            <span style="color: ${currentTaxRate > 3 ? '#C70039' : (currentTaxRate < 3 ? '#4CAF50' : '#1a73e8')}">
                ${formatCurrencyDisplay(approximateTaxBill)}
            </span>
            <span style="font-size:0.75em; font-weight:400; color:#555;">(City tax change applied to last year's bill)</span>
        `;
        
        // --- RENDER TAX BREAKDOWN ---
        const breakdown = getTaxBreakdown(approximateTaxBill);
        taxBreakdownEl.innerHTML = `
            <div style="font-weight: 700; color: #555; margin-top: 5px; border-bottom: 2px solid #ddd;">Tax Bill Breakdown:</div>
            <div>
                <span>Municipal Portion (77%)</span>
                <strong>${formatCurrencyDisplay(breakdown.muni)}</strong>
            </div>
            <div>
                <span>Alberta Education Portion (22%)</span>
                <strong>${formatCurrencyDisplay(breakdown.edu)}</strong>
            </div>
            <div>
                <span>Newell Foundation (1%)</span>
                <strong>${formatCurrencyDisplay(breakdown.newell)}</strong>
            </div>
            <div class="total">
                <span>TOTAL ESTIMATED BILL</span>
                <strong>${formatCurrencyDisplay(breakdown.total)}</strong>
            </div>
        `;
    }
    // --- END PERSONAL FINANCE DISPLAY UPDATE ---
    
    // Update guidance based on new status
    updateGuidance(displayShortfall, displaySurplus, isCommitted); 
  }

  function updateGuidance(displayShortfall, displaySurplus, isCommitted) {
    const taxValue = parseInt(taxRateInput.value);
    
    const currentProjectCost = selectedProjects.reduce((sum, i) => sum + projects[i].cost, 0);
    
    if (isCommitted) {
        guidanceText.innerHTML = `✅ Budget committed. You banked the surplus. You must now **Proceed to Next Year** or risk losing the banked amount if you change any input.`;
        return;
    }

    // If there is a net displayed shortfall (after reserve contribution)
    if (displayShortfall > 0) {
        let msg = "You must cover the shortfall by lowering service levels, increasing taxes, or using your reserve fund.";
        if (currentProjectCost > 0) {
            msg = `You have selected projects costing ${formatCurrencyDisplay(currentProjectCost)}. ${msg}`;
        } else if (taxValue < 3) {
             msg = `Your ${taxValue}% tax adjustment is below the 3% inflation rate, creating a shortfall. ${msg}`;
        }
        
        const currentYearRequiredProjects = projects.filter(p => p.type === 'required' && p.deadline === currentYear);

        if (currentYearRequiredProjects.length > 0) {
            const missingProject = currentYearRequiredProjects.find(p => !selectedProjects.includes(projects.indexOf(p)))?.name;
            if (missingProject) {
              msg += ` ⚠️ <strong>CRITICAL WARNING:</strong> The required project: ${missingProject} must be selected this year.`;
            }
        }
        
        guidanceText.innerHTML = msg;
    } else if (displaySurplus > 0) {
      guidanceText.textContent = `You have a surplus of ${formatCurrencyDisplay(displaySurplus)}. Add it to your reserve fund or proceed to the next year.`;
    } else if (reserveContribution > 0) {
        guidanceText.textContent = `The budget is balanced using ${formatCurrencyDisplay(reserveContribution)} from the reserve fund. You can proceed to the next year.`;
    } else {
      guidanceText.textContent = "The budget is balanced. You can proceed to the next year or make further adjustments.";
    }
  }

  function showSummary() { 
    document.body.innerHTML = `
      <div class="section" style="padding-bottom: 50px;">
        <h1>Budget Summary - Simulation Complete!</h1>
        <p class="intro-text">Congratulations! You have completed all ${MAX_YEARS} years of the simulation. Review your choices below.</p>
        
        <h3 style="border-bottom: 3px solid #FF5733;">Your Final Property Tax Bill:</h3>
        <p style="font-size:2em; font-weight:900; color:#C70039;">
            <strong>${formatCurrencyDisplay(lastYearTaxBill)}</strong> (Based on Final Assessment of ${formatCurrencyDisplay(userAssessment)})
        </p>

        <h3 style="border-bottom: 3px solid #1a73e8;">Final City Tax Impact:</h3>
        <p style="font-size:2em; font-weight:900; color:${totalNominalTaxRate > 3 ? '#C70039' : (totalNominalTaxRate < 3 ? '#4CAF50' : '#1a73e8')};">
            <strong>${totalNominalTaxRate.toFixed(1)}%</strong> Cumulative City Tax Adjustment
        </p>

        <h3 style="border-bottom: 3px solid #4CAF50;">Projects Completed:</h3>
        <ul style="list-style: none; padding-left: 0;">${completedProjects.length > 0 ? completedProjects.map(i => `<li style="margin-bottom: 10px; padding: 10px; background: #e8f5e9; border-left: 5px solid #4CAF50; border-radius: 5px; font-weight: 600;">✅ ${projects[i].name} (${projects[i].type})</li>`).join('') : '<li style="color: #C70039; font-weight: bold; margin-top: 15px;">❌ No projects were completed.</li>'}</ul>
        
        <h3 style="border-bottom: 3px solid #1a73e8;">Final Reserve Fund:</h3>
        <p style="font-size:2em; font-weight:900; color:${reserve > 0 ? '#4CAF50' : '#C70039'};"><strong>${formatCurrencyDisplay(reserve)}</strong></p>
        
        <button class="button" onclick="location.reload()" style="margin-top: 30px; background: linear-gradient(to bottom, #1a73e8, #1565c0); padding: 15px 25px; font-size: 1em; width: auto; min-width: 200px;">Start Over</button>
      </div>`;
  }

  function resetGame() {
    currentYear = 1;
    selectedProjects = [];
    completedProjects = [];
    reserve = 0;
    shortfall = 0;
    operatingCost = STARTING_OPERATING_COST;
    reserveContribution = 0; 
    bankedSurplus = 0; 
    totalNominalTaxRate = 0; // Reset the total nominal tax rate increase
    taxRateInput.value = 3;
    departments.forEach(dept => departmentBaselines[dept] = 100); 
    
    // --- PERSONAL FINANCE RESET (Initial User Data) ---
    userAssessment = 513000; 
    lastYearTaxBill = 5900;
    userTaxBill = 5900; 
    
    renderYearBar();
    renderPersonalAssessment();
    createProjectButtons();
    createDepartmentSliders(); 
    updateStatus();
    
    resetBtn.textContent = "Reset Year";
  }
  
  function resetYearChoices() { 
    // Clear all annual inputs/commitments
    
    taxRateInput.value = 3;
    
    // Only deselect ADDITONAL projects. Required ones stay selected if they match the deadline.
    const requiredIndicesForCurrentYear = projects
        .map((p, i) => (p.type === 'required' && p.deadline === currentYear) ? i : -1)
        .filter(i => i !== -1);
        
    selectedProjects = selectedProjects.filter(i => requiredIndicesForCurrentYear.includes(i));
    
    reserveContribution = 0; 
    bankedSurplus = 0; 
    
    // --- PERSONAL FINANCE RESET ---
    // The current year's tax bill is based on the 'lastYearTaxBill' baseline, reset to that.
    userTaxBill = lastYearTaxBill; 
    
    departments.forEach(deptName => {
        const id = deptName.replace(/\s|&/g, "");
        const slider = document.getElementById(id);
        if (slider) {
            slider.value = departmentBaselines[deptName];
            updateSliderVisuals(slider);
        }
    });
    
    createProjectButtons();
    updateStatus();
    guidanceText.textContent = "Current year choices reset! You are back to the default 3% tax increase. (Note: Required projects are NOT deselected).";
  }

  // --- Event Listeners ---
  reserveBtn.addEventListener("click", () => {
    // Determine the current visible surplus (surplus - bankedSurplus)
    const rawBalance = calculateRawBalance();
    const calculatedSurplus = Math.abs(Math.min(0, rawBalance)); 
    const currentContribution = calculatedSurplus + reserveContribution;
    const currentDisplaySurplus = Math.max(0, currentContribution - bankedSurplus);

    // 1. Move money to reserve
    reserve += currentDisplaySurplus;
    
    // 2. Track the banked amount for this year's calculation (SET THE COMMITMENT FLAG)
    bankedSurplus += currentDisplaySurplus; 
    
    updateStatus(); 
    guidanceText.innerHTML = `Surplus of ${formatCurrencyDisplay(currentDisplaySurplus)} added to Reserve Fund! The budget is now **committed** for this year. Reserve is now ${formatCurrencyDisplay(reserve)}.`;
  });

  useReserveBtn.addEventListener("click", () => { 
    // We already calculated the shortfall in updateStatus.
    if (reserve > 0 && shortfall > 0) {
      const amountToUse = Math.min(shortfall, reserve); 
      
      // Update reserveContribution, then update reserve
      reserveContribution += amountToUse; 
      reserve -= amountToUse;
      
      // We must re-run updateStatus to correctly recalculate shortfall based on the new contribution
      updateStatus(); 
      
      if (shortfall === 0) {
          guidanceText.textContent = `Reserve fund of ${formatCurrencyDisplay(amountToUse)} applied to cover deficit. The budget is now balanced.`;
      } else {
          guidanceText.textContent = `Reserve fund of ${formatCurrencyDisplay(amountToUse)} was used, but a shortfall of ${formatCurrencyDisplay(shortfall)} remains.`;
      }
    }
  });

  nextYearBtn.addEventListener("click", () => {
    
    const currentYearRequiredProjects = projects.filter(p => p.type === 'required' && p.deadline === currentYear);
    const requiredProjectsSelected = currentYearRequiredProjects.every(p => selectedProjects.includes(projects.indexOf(p)));

    if (currentYearRequiredProjects.length > 0 && !requiredProjectsSelected) {
        const missingProject = currentYearRequiredProjects.find(p => !selectedProjects.includes(projects.indexOf(p)))?.name;
        guidanceText.innerHTML = `⚠️ <strong>BUDGET FAILURE:</strong> The required project: ${missingProject} must be selected and funded this year to pass the year-end audit. Please select it to proceed.`;
        return;
    }
    
    // 1. Update Cumulative Tax Adjustment 
    const annualRate = parseInt(taxRateInput.value); 
    totalNominalTaxRate += annualRate;

    // --- PERSONAL FINANCE UPDATE (CRITICAL) ---
    // 1. Apply the annual city rate increase to the last committed tax bill
    const taxChangeMultiplier = 1 + (annualRate / 100);
    let newTaxBill = Math.round(lastYearTaxBill * taxChangeMultiplier); 
    
    // 2. Apply the assessment increase for the NEXT year's bill (this is the compounding effect)
    userAssessment = Math.round(userAssessment * (1 + ASSESSMENT_INCREASE_RATE));
    
    // 3. Since the assessment increased, we recalculate the NEW BASELINE BILL for the next year
    // This models the combination of the city's rate change AND the assessment increase.
    // We use the new assessment multiplied by the original mill rate, and then apply the compounded city rate.
    
    // Simplified model: Next year's tax bill is based on the new assessment applied to the old mill rate, then apply compounded city rate
    let newTaxBillAssessmentBase = calculateInitialTaxBill(userAssessment);
    
    // Apply the *cumulative* nominal tax rate to this new assessment base.
    // We need to calculate the full nominal increase since Year 1.
    const cumulativeTaxMultiplier = 1 + (totalNominalTaxRate / 100);
    newTaxBill = Math.round(newTaxBillAssessmentBase * cumulativeTaxMultiplier);
    
    // 4. Set the new baselines for next year
    lastYearTaxBill = newTaxBill;
    userTaxBill = lastYearTaxBill; // Update the current display baseline
    // --- END PERSONAL FINANCE UPDATE ---


    // 2. Process Department Adjustments and update operating cost
    let deptAdjustment = 0;
    departments.forEach(deptName => {
        const id = deptName.replace(/\s|&/g, "");
        const slider = document.getElementById(id);
        if (slider) {
            const currentSliderValue = parseInt(slider.value);
            
            // Calculate the actual dollar adjustment cost/savings from 100% baseline
            const adjustment = DEPT_ADJUSTMENT_PER_PERCENT * (currentSliderValue - 100);
            deptAdjustment += adjustment;
            
            // The new slider value becomes the baseline for the next year
            departmentBaselines[deptName] = currentSliderValue; 
        }
    });

    // Department adjustments permanently change the operating cost (baseline service level)
    operatingCost = operatingCost + deptAdjustment; 
    
    // 3. Complete projects
    selectedProjects.forEach(i => {
      if (!completedProjects.includes(i)) {
        completedProjects.push(i);
      }
    });
    selectedProjects = []; 
    
    currentYear++;

    if (currentYear > MAX_YEARS) {
      showSummary();
    } else {
      
      taxRateInput.value = 3; // Reset tax slider for new year (maintains the 3% base)
      reserveContribution = 0; 
      bankedSurplus = 0; // RESET banked surplus for the new year
      
      updateProgressBar();
      
      // Reset input controls for the new year
      renderPersonalAssessment();
      createProjectButtons();
      createDepartmentSliders(); 

      updateStatus();
      
      guidanceText.textContent = `🎉 You are now in Year ${currentYear}. Your new home assessment is ${formatCurrencyDisplay(userAssessment)}. Time to re-balance!`;
    }
  });

  resetBtn.addEventListener("click", () => {
    // IMPORTANT: Custom modal UI is required instead of prompt/confirm
    
    const modalId = 'resetModal';
    let modal = document.getElementById(modalId);
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        `;
        modal.innerHTML = `
            <div style="background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                <h4 style="margin-top:0; color: #1a73e8; font-weight: 700;">Reset Options</h4>
                <p>What would you like to reset?</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button id="resetYearBtn" class="button" style="background: #4CAF50; min-width: auto; padding: 10px;">Reset Current Year Choices</button>
                    <button id="resetAllConfirmBtn" class="button" style="background: #FF5733; min-width: auto; padding: 10px;">Reset ENTIRE Simulation</button>
                    <button id="resetCancelBtn" class="button" style="background: #ccc; color: #333; min-width: auto; padding: 10px; margin-top: 10px;">Cancel</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        document.getElementById('resetYearBtn').onclick = () => {
            modal.style.display = 'none';
            handleCommitmentOverride(); 
            resetYearChoices();
        };

        document.getElementById('resetAllConfirmBtn').onclick = () => {
            // Need a secondary confirmation for full reset
            // Using window.confirm() here as an exception for the full app reset scenario
            if (confirm("Are you sure you want to reset the ENTIRE simulation?")) {
                modal.style.display = 'none';
                resetGame();
            }
        };

        document.getElementById('resetCancelBtn').onclick = () => {
            modal.style.display = 'none';
        };
    }
    
    modal.style.display = 'flex';
  });

  taxRateInput.addEventListener("input", () => {
      // --- COMMITMENT PENALTY CHECK ---
      handleCommitmentOverride();
      
      // The below lines effectively re-run updateStatus
      bankedSurplus = 0; 
      reserveContribution = 0;
      createProjectButtons(); // Re-render projects to ensure correct state
      updateStatus();
  });

  // --- Initialization ---
  document.fonts.ready.then(() => {
    console.log("Fonts loaded, starting game.");
    // Initial Render call to set up the assessment input field with a default value
    renderPersonalAssessment(); 
    resetGame();
  });

</script>
</body>
</html>
